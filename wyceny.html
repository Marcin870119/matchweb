<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprawdzarka cen</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <style>
        /* Dodaj tutaj swoje style, je≈õli sƒÖ potrzebne */
        #dropdown {
            width: 100%; /* Dopasuj do szeroko≈õci inputa */
        }
    </style>
</head>
<body>
    <h1>Sprawdzarka cen</h1>

    <div>
        <label for="search">Wyszukaj produkt:</label>
        <input type="text" id="search" placeholder="Wpisz indeks lub nazwƒô...">
        <select id="dropdown" style="display: none;"></select> </div>

    <h2>Wybrany produkt</h2>
    <table id="resultTable" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Indeks</th>
                <th>Nazwa</th>
                <th>Producent</th>
                <th>Grupa</th>
                <th>JM</th>
                <th>Opak. zbiorcze</th>
                <th>Paleta</th>
                <th>Warstwa</th>
                <th>Cena</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div>
        <label for="price">Wprowad≈∫ cenƒô:</label>
        <input type="number" id="price" step="0.01">
        <button id="calculateButton">Sprawd≈∫</button>
    </div>
    <p id="priceMessage"></p>



    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="module">
        // Inicjalizacja Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

        // Konfiguracja Firebase (wklej SWOJE dane!)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };


        // Inicjalizacja aplikacji Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Pobranie referencji do element√≥w HTML
        const searchInput = document.getElementById('search');
        //const dropdownButton = document.getElementById('dropdownButton'); // Nie jest u≈ºywane, wiƒôc usuwam
        const dropdown = document.getElementById('dropdown');
        const resultTable = document.getElementById('resultTable').querySelector('tbody');
        const priceInput = document.getElementById('price');
        const priceMessage = document.getElementById('priceMessage');
        const calculateButton = document.getElementById('calculateButton');

        let items = [];
        let minPrices = {};
        let selectedItem = null; // Zmienna do przechowywania wybranego produktu


        // Funkcja do pobrania danych z Firestore
        async function fetchFirestoreData() {
            try {
                const querySnapshot = await getDocs(collection(db, "products"));
                items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Dodaj ID do danych
                console.log("üî• Pobrane dane z Firestore:", items);
                populateDropdown(items);
            } catch (error) {
                console.error("‚ùå B≈ÇƒÖd podczas pobierania danych Firestore:", error);
            }
        }



        // Inicjalizacja danych
        fetchFirestoreData();

        // Obs≈Çuga wyszukiwania
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filterDropdown(items, searchTerm);
            dropdown.style.display = searchTerm.length > 0 ? 'block' : 'none';
        });

      // Obs≈Çuga wyboru produktu z listy rozwijanej
        dropdown.addEventListener('change', () => {
            const selectedId = dropdown.value;
            if (selectedId) {
                selectedItem = items.find(item => item.id === selectedId);
                displaySelectedItem(selectedItem);
                searchInput.value = `${selectedItem.INDEKS} - ${selectedItem.NAZWA}`; // Wstaw nazwƒô do inputa
                dropdown.style.display = 'none'; // Schowaj dropdown po wyborze
            }
        });


        // Funkcja do wype≈Çnienia dropdowna produktami
        function populateDropdown(items) {
             dropdown.innerHTML = '<option value="">Wybierz produkt</option>'; // Dodaj pustƒÖ opcjƒô
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id; // U≈ºyj ID jako warto≈õci
                option.textContent = `${item.INDEKS} - ${item.NAZWA}`;
                dropdown.appendChild(option);
            });
        }

        // Funkcja do filtrowania dropdowna
        function filterDropdown(items, searchTerm) {
            const filteredItems = items.filter(item =>
                item.INDEKS.toString().toLowerCase().includes(searchTerm) || item.NAZWA.toLowerCase().includes(searchTerm)
            );
            populateDropdown(filteredItems);
        }



        // Funkcja do wy≈õwietlania wybranego produktu w tabeli
        function displaySelectedItem(item) {
            if (!item) {
                console.warn("‚ùå Nie znaleziono danych dla podanego indeksu.");
                return;
            }

            console.log("üîπ Wybrany produkt:", item);

            // Usuwanie poprzednich danych
            if ($.fn.DataTable.isDataTable('#resultTable')) { // Sprawd≈∫, czy DataTable ju≈º istnieje
                 $('#resultTable').DataTable().clear().destroy();
            }

            // Aktualizacja tabeli z nowymi danymi
            resultTable.innerHTML = `
                <tr>
                    <td>${item.INDEKS || "Brak danych"}</td>
                    <td>${item.NAZWA || "Brak danych"}</td>
                    <td>${item.SKROT_PRODUCENTA || "Brak danych"}</td>
                    <td>${item.GRUPA_NAZWA || "Brak danych"}</td>
                    <td>${item.JM_NAZWA || "Brak danych"}</td>
                    <td>${item.OPK_ZB_IL || "Brak danych"}</td>
                    <td>${item.IL_PALETA_T || "Brak danych"}</td>
                    <td>${item.IL_WARSTWA_T || "Brak danych"}</td>
                    <td>${item.CEN100_UK || "Brak danych"}</td>
                </tr>
            `;

            // Ponowna inicjalizacja DataTables
            $('#resultTable').DataTable({
                scrollY: '200px',
                scrollX: true,
                scrollCollapse: true,
                paging: false,
                autoWidth: false,
                info: false,
                // destroy: true,  // Ju≈º to sprawdzamy wy≈ºej
                columnDefs: [{ width: '150px', targets: '_all' }]
            });
        }



       // Pobranie cen minimalnych
        async function fetchMinPrices() {
            try {
                const querySnapshot = await getDocs(collection(db, "minPrices"));
                minPrices = querySnapshot.docs.reduce((acc, doc) => {
                    acc[doc.data().INDEKS] = doc.data()['Cena minimalna'];  //Poprawione
                    return acc;
                }, {});
                console.log("‚úÖ Pobrane ceny minimalne:", minPrices);
            } catch (error) {
                console.error("‚ùå B≈ÇƒÖd podczas pobierania cen minimalnych:", error);
            }
        }

        // Pobranie cen minimalnych
        fetchMinPrices();


        // Obs≈Çuga sprawdzania ceny
        calculateButton.addEventListener('click', () => {
            let price = parseFloat(priceInput.value);
            if (!isNaN(price)) {
                price = price.toFixed(2);
                priceInput.value = price;
                if (selectedItem) {
                    checkPrice(price, selectedItem.INDEKS);
                } else {
                    priceMessage.textContent = 'Nie wybrano produktu.';
                    priceMessage.style.color = 'black';
                }
            }
        });

// Funkcja do sprawdzania ceny
        function checkPrice(price, index) {
            const minPrice = minPrices[index];

            if (minPrice !== undefined) { // Sprawdzaj czy minPrice jest zdefiniowane, a nie czy jest truthy
                if (parseFloat(price) === 0) { // Por√≥wnuj sparsowane warto≈õci
                    priceMessage.textContent = 'Skontakuj siƒô z Twoim opiekunem.';
                    priceMessage.style.color = 'red';
                } else if (parseFloat(price) >= parseFloat(minPrice)) { // Por√≥wnuj sparsowane warto≈õci
                    priceMessage.textContent = 'Cena jest odpowiednia.';
                    priceMessage.style.color = 'green';
                } else if (parseFloat(price) < parseFloat(minPrice) * 0.9) { // Por√≥wnuj sparsowane warto≈õci
                    priceMessage.textContent = 'Skontakuj siƒô z Twoim opiekunem.';
                    priceMessage.style.color = 'red';
                } else {
                    const adjustedPrice = (parseFloat(minPrice) * 1.02).toFixed(2);
                    priceMessage.textContent = `Sugerowana cena: ${adjustedPrice}`;
                    priceMessage.style.color = 'orange';
                }
            } else {
                priceMessage.textContent = 'Nie znaleziono minimalnej ceny dla tego indeksu.';
                priceMessage.style.color = 'black';
            }
        }


    </script>
</body>
</html>
